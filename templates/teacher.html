{% extends "base.html" %}

{% block title %}Teacher Dashboard - Who Am I?{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .stat-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
    }
    .chart-container {
        position: relative;
        height: 300px;
    }
    @media (min-width: 768px) {
        .chart-container {
            height: 350px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen py-8 px-4">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8 gap-4">
            <div>
                <h1 class="font-display text-3xl text-sky-600 mb-1">üçé Teacher Dashboard</h1>
                <p class="text-gray-600">View class identity rankings</p>
            </div>
            <div class="flex gap-3">
                <button 
                    id="refreshBtn"
                    class="px-4 py-2 bg-sky-100 hover:bg-sky-200 text-sky-700 font-semibold rounded-xl transition-colors"
                >
                    üîÑ Refresh
                </button>
                <button 
                    id="resetBtn"
                    class="px-4 py-2 bg-coral-100 hover:bg-coral-200 text-coral-600 font-semibold rounded-xl transition-colors"
                >
                    üóëÔ∏è Clear All Data
                </button>
            </div>
        </div>
        
        <!-- Stats Row -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="stat-card">
                <div class="text-3xl font-display font-bold text-sky-600" id="totalSubmissions">-</div>
                <div class="text-gray-600 font-medium">Total Submissions</div>
            </div>
            <div class="stat-card">
                <div class="text-3xl font-display font-bold text-gold-500" id="topIdentity">-</div>
                <div class="text-gray-600 font-medium">Most Common Identity</div>
            </div>
            <div class="stat-card">
                <div class="text-3xl font-display font-bold text-coral-500" id="godRank">-</div>
                <div class="text-gray-600 font-medium">"Child of God" Avg. Rank</div>
            </div>
        </div>
        
        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Most Common Identities -->
            <div class="bg-white/90 backdrop-blur rounded-2xl card-shadow p-6">
                <h2 class="font-display text-xl text-sky-600 mb-4">Most Common Identities</h2>
                <div class="chart-container">
                    <canvas id="frequencyChart"></canvas>
                </div>
            </div>
            
            <!-- Importance Ranking -->
            <div class="bg-white/90 backdrop-blur rounded-2xl card-shadow p-6">
                <h2 class="font-display text-xl text-gold-500 mb-4">Most Important (by Avg. Rank)</h2>
                <div class="chart-container">
                    <canvas id="importanceChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Child of God Highlight -->
        <div id="godHighlight" class="bg-gradient-to-r from-gold-100 to-coral-100 rounded-2xl card-shadow p-6 mb-8 hidden">
            <div class="flex items-center gap-4">
                <div class="text-5xl">‚ú®</div>
                <div>
                    <h3 class="font-display text-2xl text-gray-800" id="godHighlightTitle">Child of God</h3>
                    <p class="text-gray-600" id="godHighlightText">Loading...</p>
                </div>
            </div>
        </div>
        
        <!-- Recent Submissions Table -->
        <div class="bg-white/90 backdrop-blur rounded-2xl card-shadow p-6">
            <h2 class="font-display text-xl text-coral-500 mb-4">Recent Submissions</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b-2 border-gray-100">
                            <th class="text-left py-3 px-4 font-semibold text-gray-600">#</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-600">Time</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-600">Identities (ranked)</th>
                        </tr>
                    </thead>
                    <tbody id="submissionsTable">
                        <tr>
                            <td colspan="3" class="py-8 text-center text-gray-400">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Class Link -->
        <div class="mt-8 text-center">
            <p class="text-gray-600 mb-2">Share this link with your class:</p>
            <div class="inline-flex items-center gap-2 bg-white/80 rounded-xl px-4 py-2 card-shadow">
                <code id="classLink" class="text-sky-600 font-mono">Loading...</code>
                <button id="copyLink" class="text-gray-400 hover:text-sky-600 transition-colors">
                    üìã
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let frequencyChart, importanceChart;
    
    // Chart colors
    const chartColors = [
        '#38bdf8', '#fbbf24', '#fb7185', '#a3e635', '#c084fc',
        '#2dd4bf', '#f472b6', '#60a5fa', '#facc15', '#4ade80'
    ];
    
    async function loadData() {
        try {
            const response = await fetch('/api/results');
            const data = await response.json();
            
            updateStats(data);
            updateCharts(data);
            updateTable(data.submissions);
            updateGodHighlight(data.child_of_god);
            
        } catch (error) {
            console.error('Error loading data:', error);
        }
    }
    
    function updateStats(data) {
        document.getElementById('totalSubmissions').textContent = data.total_submissions;
        
        if (data.by_frequency.length > 0) {
            document.getElementById('topIdentity').textContent = capitalize(data.by_frequency[0][0]);
        } else {
            document.getElementById('topIdentity').textContent = 'N/A';
        }
        
        if (data.child_of_god) {
            document.getElementById('godRank').textContent = '#' + data.child_of_god.avg_rank.toFixed(1);
        } else {
            document.getElementById('godRank').textContent = 'Not ranked yet';
        }
    }
    
    function updateCharts(data) {
        // Destroy existing charts
        if (frequencyChart) frequencyChart.destroy();
        if (importanceChart) importanceChart.destroy();
        
        // Frequency Chart
        const freqCtx = document.getElementById('frequencyChart').getContext('2d');
        frequencyChart = new Chart(freqCtx, {
            type: 'bar',
            data: {
                labels: data.by_frequency.map(([name]) => capitalize(name)),
                datasets: [{
                    label: 'Times Mentioned',
                    data: data.by_frequency.map(([_, count]) => count),
                    backgroundColor: chartColors,
                    borderRadius: 8,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });
        
        // Importance Chart (lower rank = more important, so we invert for visualization)
        const impCtx = document.getElementById('importanceChart').getContext('2d');
        const maxRank = Math.max(...data.by_importance.map(([_, rank]) => rank)) + 1;
        
        importanceChart = new Chart(impCtx, {
            type: 'bar',
            data: {
                labels: data.by_importance.map(([name]) => capitalize(name)),
                datasets: [{
                    label: 'Importance Score',
                    data: data.by_importance.map(([_, rank]) => (maxRank - rank).toFixed(2)),
                    backgroundColor: data.by_importance.map(([name], i) => 
                        name.toLowerCase().includes('god') ? '#fbbf24' : chartColors[i % chartColors.length]
                    ),
                    borderRadius: 8,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const rank = data.by_importance[context.dataIndex][1];
                                return `Average Rank: #${rank.toFixed(1)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        display: false
                    }
                }
            }
        });
    }
    
    function updateTable(submissions) {
        const tbody = document.getElementById('submissionsTable');
        
        if (submissions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="py-8 text-center text-gray-400">No submissions yet. Share the link with your class!</td></tr>';
            return;
        }
        
        tbody.innerHTML = submissions.slice(0, 20).map((sub, i) => `
            <tr class="border-b border-gray-50 hover:bg-gray-50">
                <td class="py-3 px-4 text-gray-500">${i + 1}</td>
                <td class="py-3 px-4 text-gray-600 text-sm">${formatTime(sub.created_at)}</td>
                <td class="py-3 px-4">
                    <div class="flex flex-wrap gap-1">
                        ${sub.identities.map((id, rank) => `
                            <span class="inline-block px-2 py-1 text-xs font-medium rounded-full ${
                                id.toLowerCase().includes('god') 
                                    ? 'bg-gold-100 text-gold-700' 
                                    : rank === 0 
                                        ? 'bg-sky-100 text-sky-700'
                                        : 'bg-gray-100 text-gray-600'
                            }">
                                ${rank + 1}. ${escapeHtml(id)}
                            </span>
                        `).join('')}
                    </div>
                </td>
            </tr>
        `).join('');
    }
    
    function updateGodHighlight(godData) {
        const highlight = document.getElementById('godHighlight');
        
        if (!godData) {
            highlight.classList.add('hidden');
            return;
        }
        
        highlight.classList.remove('hidden');
        document.getElementById('godHighlightTitle').textContent = capitalize(godData.identity);
        
        const avgRank = godData.avg_rank;
        let message = '';
        
        if (avgRank <= 1.5) {
            message = `Amazing! The class ranked "${capitalize(godData.identity)}" as their #1 most important identity on average! üåü`;
        } else if (avgRank <= 3) {
            message = `Great news! "${capitalize(godData.identity)}" was ranked in the top 3 most important identities (avg: #${avgRank.toFixed(1)}).`;
        } else {
            message = `"${capitalize(godData.identity)}" was mentioned ${godData.count} time(s) with an average rank of #${avgRank.toFixed(1)}. Consider discussing why this identity is so special!`;
        }
        
        document.getElementById('godHighlightText').textContent = message;
    }
    
    function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    
    function capitalize(str) {
        return str.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Event listeners
    document.getElementById('refreshBtn').addEventListener('click', loadData);
    
    document.getElementById('resetBtn').addEventListener('click', async () => {
        if (!confirm('Are you sure you want to clear all submissions? This cannot be undone.')) {
            return;
        }
        
        try {
            await fetch('/api/reset', { method: 'POST' });
            loadData();
        } catch (error) {
            alert('Error clearing data');
        }
    });
    
    // Set class link
    document.getElementById('classLink').textContent = window.location.origin;
    
    document.getElementById('copyLink').addEventListener('click', () => {
        navigator.clipboard.writeText(window.location.origin);
        alert('Link copied!');
    });
    
    // Initial load
    loadData();
    
    // Auto-refresh every 30 seconds
    setInterval(loadData, 30000);
</script>
{% endblock %}

