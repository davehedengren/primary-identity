{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .stat-value {
        font-size: 2rem;
        font-weight: 600;
        letter-spacing: -0.02em;
    }
    .chart-container {
        position: relative;
        height: 280px;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen py-12 px-4">
    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
            <div>
                <h1 class="text-2xl font-semibold text-apple-gray-900 tracking-tight">Dashboard</h1>
                <p class="text-apple-gray-400">Class identity rankings</p>
            </div>
            <div class="flex gap-2">
                <a 
                    href="/api/results/download"
                    class="btn-primary px-4 py-2 text-sm"
                >
                    Download CSV
                </a>
                <button 
                    id="refreshBtn"
                    class="btn-secondary px-4 py-2 text-sm"
                >
                    Refresh
                </button>
                <button 
                    id="resetBtn"
                    class="px-4 py-2 text-sm font-medium text-red-500 bg-red-50 rounded-lg hover:bg-red-100 transition-colors"
                >
                    Clear Data
                </button>
            </div>
        </header>
        
        <!-- Stats -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
            <div class="card p-5">
                <div class="stat-value text-apple-blue" id="totalSubmissions">—</div>
                <div class="text-apple-gray-400 text-sm font-medium mt-1">Submissions</div>
            </div>
            <div class="card p-5">
                <div class="stat-value text-apple-gray-900 text-xl" id="topIdentity">—</div>
                <div class="text-apple-gray-400 text-sm font-medium mt-1">Most Common</div>
            </div>
            <div class="card p-5">
                <div class="stat-value text-amber-500" id="godRank">—</div>
                <div class="text-apple-gray-400 text-sm font-medium mt-1">"Child of God" Rank</div>
            </div>
        </div>
        
        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-8">
            <div class="card p-5">
                <h2 class="text-base font-semibold text-apple-gray-900 mb-4">Most Common</h2>
                <div class="chart-container">
                    <canvas id="frequencyChart"></canvas>
                </div>
            </div>
            
            <div class="card p-5">
                <h2 class="text-base font-semibold text-apple-gray-900 mb-4">By Importance</h2>
                <div class="chart-container">
                    <canvas id="importanceChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Highlight -->
        <div id="godHighlight" class="card p-5 mb-8 border-l-4 border-amber-400 hidden">
            <p class="text-apple-gray-600" id="godHighlightText">Loading...</p>
        </div>
        
        <!-- Table -->
        <div class="card p-5">
            <h2 class="text-base font-semibold text-apple-gray-900 mb-4">Recent Submissions</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-apple-gray-100">
                            <th class="text-left py-3 px-2 text-xs font-semibold text-apple-gray-400 uppercase tracking-wider">#</th>
                            <th class="text-left py-3 px-2 text-xs font-semibold text-apple-gray-400 uppercase tracking-wider">Time</th>
                            <th class="text-left py-3 px-2 text-xs font-semibold text-apple-gray-400 uppercase tracking-wider">Identities</th>
                        </tr>
                    </thead>
                    <tbody id="submissionsTable">
                        <tr>
                            <td colspan="3" class="py-10 text-center text-apple-gray-300">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Share Link -->
        <div class="mt-8 text-center">
            <p class="text-apple-gray-400 text-sm mb-2">Student link</p>
            <div class="inline-flex items-center gap-2 card px-4 py-2">
                <code id="classLink" class="text-apple-blue text-sm font-mono">—</code>
                <button id="copyLink" class="text-apple-gray-300 hover:text-apple-blue transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let frequencyChart, importanceChart;
    
    const chartColors = ['#007AFF', '#34C759', '#FF9500', '#AF52DE', '#FF3B30', '#5AC8FA', '#FFCC00', '#FF2D55'];
    
    Chart.defaults.font.family = "-apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif";
    Chart.defaults.color = '#8E8E93';
    
    async function loadData() {
        try {
            const response = await fetch('/api/results');
            const data = await response.json();
            
            updateStats(data);
            updateCharts(data);
            updateTable(data.submissions);
            updateGodHighlight(data.child_of_god);
            
        } catch (error) {
            console.error('Error loading data:', error);
        }
    }
    
    function updateStats(data) {
        document.getElementById('totalSubmissions').textContent = data.total_submissions;
        
        if (data.by_frequency.length > 0) {
            document.getElementById('topIdentity').textContent = capitalize(data.by_frequency[0][0]);
        } else {
            document.getElementById('topIdentity').textContent = '—';
        }
        
        if (data.child_of_god) {
            document.getElementById('godRank').textContent = '#' + data.child_of_god.avg_rank.toFixed(1);
        } else {
            document.getElementById('godRank').textContent = '—';
        }
    }
    
    function updateCharts(data) {
        if (frequencyChart) frequencyChart.destroy();
        if (importanceChart) importanceChart.destroy();
        
        const freqCtx = document.getElementById('frequencyChart').getContext('2d');
        frequencyChart = new Chart(freqCtx, {
            type: 'bar',
            data: {
                labels: data.by_frequency.slice(0, 8).map(([name]) => capitalize(name)),
                datasets: [{
                    data: data.by_frequency.slice(0, 8).map(([_, count]) => count),
                    backgroundColor: chartColors,
                    borderRadius: 6,
                    barThickness: 24,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 }, grid: { color: '#F5F5F7' } },
                    x: { grid: { display: false } }
                }
            }
        });
        
        const impCtx = document.getElementById('importanceChart').getContext('2d');
        const maxRank = Math.max(...data.by_importance.map(([_, rank]) => rank)) + 1;
        
        importanceChart = new Chart(impCtx, {
            type: 'bar',
            data: {
                labels: data.by_importance.slice(0, 8).map(([name]) => capitalize(name)),
                datasets: [{
                    data: data.by_importance.slice(0, 8).map(([_, rank]) => (maxRank - rank).toFixed(2)),
                    backgroundColor: data.by_importance.slice(0, 8).map(([name], i) => 
                        name.toLowerCase().includes('god') ? '#FF9500' : chartColors[i % chartColors.length]
                    ),
                    borderRadius: 6,
                    barThickness: 16,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const rank = data.by_importance[context.dataIndex][1];
                                return `Avg Rank: #${rank.toFixed(1)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: { display: false },
                    y: { grid: { display: false } }
                }
            }
        });
    }
    
    function updateTable(submissions) {
        const tbody = document.getElementById('submissionsTable');
        
        if (submissions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="py-10 text-center text-apple-gray-300">No submissions yet</td></tr>';
            return;
        }
        
        tbody.innerHTML = submissions.slice(0, 15).map((sub, i) => `
            <tr class="border-b border-apple-gray-50">
                <td class="py-3 px-2 text-apple-gray-400 text-sm">${i + 1}</td>
                <td class="py-3 px-2 text-apple-gray-400 text-sm">${formatTime(sub.created_at)}</td>
                <td class="py-3 px-2">
                    <div class="flex flex-wrap gap-1">
                        ${sub.identities.map((id, rank) => `
                            <span class="inline-block px-2 py-0.5 text-xs font-medium rounded-full ${
                                id.toLowerCase().includes('god') 
                                    ? 'bg-amber-100 text-amber-700' 
                                    : 'bg-apple-gray-100 text-apple-gray-600'
                            }">
                                ${escapeHtml(id)}
                            </span>
                        `).join('')}
                    </div>
                </td>
            </tr>
        `).join('');
    }
    
    function updateGodHighlight(godData) {
        const highlight = document.getElementById('godHighlight');
        
        if (!godData) {
            highlight.classList.add('hidden');
            return;
        }
        
        highlight.classList.remove('hidden');
        const avgRank = godData.avg_rank;
        let message = '';
        
        if (avgRank <= 1.5) {
            message = `"Child of God" was ranked #1 on average — the class understands what matters most.`;
        } else if (avgRank <= 3) {
            message = `"Child of God" ranked in the top 3 (avg: #${avgRank.toFixed(1)}). Great discussion opportunity.`;
        } else {
            message = `"Child of God" was mentioned ${godData.count} time(s) with an average rank of #${avgRank.toFixed(1)}.`;
        }
        
        document.getElementById('godHighlightText').textContent = message;
    }
    
    function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    
    function capitalize(str) {
        return str.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    document.getElementById('refreshBtn').addEventListener('click', loadData);
    
    document.getElementById('resetBtn').addEventListener('click', async () => {
        if (!confirm('Clear all submissions?')) return;
        try {
            await fetch('/api/reset', { method: 'POST' });
            loadData();
        } catch (error) {}
    });
    
    document.getElementById('classLink').textContent = window.location.origin;
    
    document.getElementById('copyLink').addEventListener('click', () => {
        navigator.clipboard.writeText(window.location.origin);
    });
    
    loadData();
    setInterval(loadData, 30000);
</script>
{% endblock %}
